# Gemini 2.5 Flash用 apply_diff エラー抑制プロンプト

## 🚨 CRITICAL: apply_diff形式の厳密ルール

### 絶対に守るべき形式要件
- **SEARCHセクション**: 既存コードを**バイト単位で完全一致**させる
- **REPLACEセクション**: **新しいコードのみ**、マーカーや説明文は絶対に含めない
- **一文字でも違いがあれば失敗する**

### 標準テンプレート
```
```apply_diff
file: パス/ファイル名
<<<<<<< SEARCH
[既存コードを正確にコピー]
>>>>>>> SEARCH
<<<<<<< REPLACE
[新しいコードのみ]
>>>>>>> REPLACE
```
```

## ❌ 絶対にやってはいけないこと

### 1. マーカーの混入
```
❌ 間違い:
<<<<<<< REPLACE
:start_line: 15
func newFunc() {
>>>>>>> REPLACE

✅ 正しい:
<<<<<<< REPLACE
func newFunc() {
    return "correct"
}
>>>>>>> REPLACE
```

### 2. 説明文の混入
```
❌ 間違い:
<<<<<<< REPLACE
// logパッケージのインポートを追加
import "log"
>>>>>>> REPLACE

✅ 正しい:
<<<<<<< REPLACE
import "log"
>>>>>>> REPLACE
```

### 3. 不完全なコードブロック
```
❌ 間違い:
<<<<<<< SEARCH
func test() {
>>>>>>> SEARCH

✅ 正しい:
<<<<<<< SEARCH
func test() {
    return nil
}
>>>>>>> SEARCH
```

## 📋 必須チェックリスト

### コード変更前の準備
1. □ 変更対象ファイルの該当部分を正確に特定
2. □ SEARCHに含める既存コード範囲を明確化
3. □ REPLACEに含める新コードを事前に完全作成
4. □ インデント・空白文字の確認
5. □ 形式チェック（マーカー混入がないか）

### apply_diff生成後の自己検証
1. □ SEARCHセクションに既存コード以外の文字がないか
2. □ REPLACEセクションにマーカーや説明が含まれていないか
3. □ ファイルパスが正確か
4. □ インデントが保持されているか
5. □ 括弧・引用符のペアが正しいか

## 🔄 段階的実行プロセス

### Step 1: 変更内容の分析
```
変更が必要な要素:
- インポート追加: [具体的なパッケージ]
- 関数修正: [関数名と変更内容]
- 構造体変更: [フィールド名と型]
```

### Step 2: 変更の分割
```
複数箇所変更時は以下の順序で分割:
1. インポート文の追加/修正
2. 関数の修正
3. 構造体の修正
4. その他の変更

※ 1つのapply_diffブロックで1つの論理的変更のみ
```

### Step 3: SEARCHセクションの準備
```
既存コードを以下から正確にコピー:
- ファイルの該当行範囲
- インデント・空白文字も含めて完全一致
- 前後の関数や構造体の境界を明確に
```

### Step 4: REPLACEセクションの作成
```
新しいコードのみを含む:
- マーカーや説明文は一切含めない
- インデント・フォーマットを既存コードに合わせる
- 構文エラーがないことを確認
```

## 🎯 roocodeツール特化の注意点

### 特別な制約事項
- ファイル内容の**完全一致**が必須
- **空白文字やタブの違い**も失敗原因となる
- 変更範囲は**最小限**に抑える
- **一度に大きな変更をしない**

### 推奨戦略
1. **最小変更の原則**: 必要最小限の行のみを変更
2. **段階的適用**: 大きな変更は複数のapply_diffに分割
3. **事前検証**: コードの構文チェックを事前に実行
4. **一致確認**: SEARCHセクションが元ファイルと完全一致するか確認

## 💡 成功パターンの例

### インポート追加の例
```apply_diff
file: main.go
<<<<<<< SEARCH
import (
    "fmt"
)
>>>>>>> SEARCH
<<<<<<< REPLACE
import (
    "fmt"
    "log"
)
>>>>>>> REPLACE
```

### 関数修正の例
```apply_diff
file: handler.go
<<<<<<< SEARCH
func processData(data string) error {
    return nil
}
>>>>>>> SEARCH
<<<<<<< REPLACE
func processData(data string) error {
    if data == "" {
        return fmt.Errorf("empty data")
    }
    return nil
}
>>>>>>> REPLACE
```

## 🚀 実行前の最終確認

**apply_diffを送信する前に、以下を声に出して確認:**

1. "SEARCHセクションは既存コードそのものか？"
2. "REPLACEセクションに余計な文字はないか？"
3. "ファイルパスは正確か？"
4. "インデントは保持されているか？"

**これらすべてに「YES」と答えられる場合のみ、apply_diffを実行する。**